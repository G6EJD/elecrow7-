esphome:
  name: elecrowdisplay
  friendly_name: elecrowdisplay
  platformio_options:
     build_flags: "-DBOARD_HAS_PSRAM"
     board_build.esp-idf.memory_type: qio_opi
     board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: y
      CONFIG_ESP32S3_DATA_CACHE_64KB: y
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "KfIrJrQ/n5B0uJaXxu9HhCxR28hN7URGC3XORw9hHLg="

ota:
  - platform: esphome
    password: "61fddc73f16c640b25a662dac83d7ea0"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  reboot_timeout: 1min

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Ha-Sensor-Display"
    password: "goHylpGT3lVh"

captive_portal:

font:
  - file: '/config/esphome/font/inter-regular.ttf' #'gfont://Inter_18pt-Medium.ttf'
    id: myFont 
    size: 24
  - file: '/config/esphome/font/inter-regular.ttf' #'gfont://Inter_18pt-Medium.ttf'
    id: myFont40 
    size: 40
  - file: '/config/esphome/font/inter-regular.ttf' #'gfont://Inter_18pt-Medium.ttf'
    id: myFont60 
    size: 60
  - file: '/config/esphome/font/materialdesignicons-webfont.ttf'
    id: icon_font_30
    size: 30
    glyphs:
      - "\U000F0590" # weather-cloudy - Nuageux
      - "\U000F0591" # weather-fog - Brouillard
      - "\U000F0592" # weather-hail - Grele      
      - "\U000F0593" # weather-lightning - Orage
      - "\U000F0594" # weather-clear-night - Nuit claire
      - "\U000F0595" # weather-partly-cloudy - Partiellement nuageux
      - "\U000F0596" # weather-pouring - Pluie forte
      - "\U000F0597" # weather-rainy - Pluie
      - "\U000F0598" # weather-snowy - Neige
      - "\U000F0599" # weather-sunny - Soleil
      - "\U000F0F30" # weather-hazy - brume
      - "\U000F0F31" # weather-night-partly-cloudy - Nuit partiellement nuageuse
      - "\U000F0F32" # weather-partly-lightning - Orage partiel
      - "\U000F0F33" # weather-partly-rainy - Pluie partielle
      - "\U000F0F34" # weather-partly-snowy - Neige partielle
      - "\U000F0F35" # weather-partly-snowy-rainy -Neige pluie partielle
      - "\U000F0F36" # weather-snowy-heavy - Neige forte
      - "\U000F059D" # weather-windy - Vent
      - "\U000F067E" # weather-lightning-rainy - Orage pluie
      - "\U000F059E" # weather-windy-variant - Vent variante
      - "\U000F0F2F" # weather-exceptional - Exceptionnel
      - "\U000F12A3" # battery
      - "\U000F058C" # water
      - "\U000F050F" # thermometer
      - "\U000F1442" # clock
      - "\U000F058E" # humidity

  - file: '/config/esphome/font/materialdesignicons-webfont.ttf'
    id: icon_font_90
    size: 90
    glyphs:
      - "\U000F0590" # weather-cloudy - Nuageux
      - "\U000F0591" # weather-fog - Brouillard
      - "\U000F0592" # weather-hail - Grele      
      - "\U000F0593" # weather-lightning - Orage
      - "\U000F0594" # weather-clear-night - Nuit claire
      - "\U000F0595" # weather-partly-cloudy - Partiellement nuageux
      - "\U000F0596" # weather-pouring - Pluie forte
      - "\U000F0597" # weather-rainy - Pluie
      - "\U000F0598" # weather-snowy - Neige
      - "\U000F0599" # weather-sunny - Soleil
      - "\U000F0F30" # weather-hazy - brume
      - "\U000F0F31" # weather-night-partly-cloudy - Nuit partiellement nuageuse
      - "\U000F0F32" # weather-partly-lightning - Orage partiel
      - "\U000F0F33" # weather-partly-rainy - Pluie partielle
      - "\U000F0F34" # weather-partly-snowy - Neige partielle
      - "\U000F0F35" # weather-partly-snowy-rainy -Neige pluie partielle
      - "\U000F0F36" # weather-snowy-heavy - Neige forte
      - "\U000F059D" # weather-windy - Vent
      - "\U000F067E" # weather-lightning-rainy - Orage pluie
      - "\U000F059E" # weather-windy-variant - Vent variante
      - "\U000F0F2F" # weather-exceptional - Exceptionnel
      - "\U000F058C" # water
      - "\U000F050F" # thermometer
      - "\U000F1442" # clock
      - "\U000F058E" # humidity
      - "\U000F12A3" # battery-high
      - "\U000F12A2" # battery-medium
      - "\U000F12A1" # battery-low

color:
  - id: red
    hex: FF0000
  - id: green
    hex: 00FF00
  - id: blue
    hex: 0000FF
  - id: sky_blue
    hex: 3FA7F3
  - id: yellow
    hex: FFFF00

psram:
  mode: octal
  speed: 80MHz

i2c:
  sda: 19
  scl: 20
  frequency: 400000
  id: i2c_bus

output:
  - platform: ledc
    pin: 2
    frequency: 1220
    id: gpio_backlight_pwm

light:
  - platform: monochromatic 
    output: gpio_backlight_pwm
    name: ${devicename} Display Backlight
    id: back_light
    restore_mode: ALWAYS_ON

time:
  - platform: homeassistant
    id: currenttime
    timezone: Europe/London
    
touchscreen:
  platform: gt911
  id: touch_gt911
  address: 0x5D
  # Remove the old on_touch action or modify if needed for new interactions
  # on_touch:
  #   then:
  #     - lambda: |-
  #         // Example: Log touch coordinates if debugging
  #         // ESP_LOGD("touch", "Touch at x=%d, y=%d", x, y);


#State is the forecast

text_sensor:
  - platform: homeassistant
    entity_id: weather.home
    id: myWeather
    internal: true

  - platform: homeassistant
    entity_id: weather.forecast_home
    id: myTemperature
    attribute: "temperature"
    internal: true

  - platform: homeassistant
    entity_id: weather.forecast_home
    id: myHumidity
    attribute: "humidity"
    internal: true

  - platform: homeassistant
    entity_id: weather.forecast_home
    id: myWindBearing
    attribute: "wind_bearing"
    internal: true

  - platform: homeassistant
    entity_id: weather.forecast_home
    id: myWindspeed
    attribute: "wind_speed"
    internal: true

  - platform: homeassistant
    entity_id: weather.forecast_home
    id: myDewpoint
    attribute: "dew_point"
    internal: true

  - platform: homeassistant
    entity_id: weather.forecast_home
    id: myPressure
    attribute: "pressure"
    internal: true

  - platform: homeassistant
    entity_id: sensor.battery_charge
    id: myBattery
    internal: true

#Attributes
#temperature: 8
#dew_point: 6.9
#temperature_unit: °C
#humidity: 93
#cloud_coverage: 36.7
#uv_index: 0
#pressure: 1005.1
#pressure_unit: hPa
#wind_bearing: 215.1
#wind_speed: 15.1
#wind_speed_unit: km/h
#visibility_unit: km
#precipitation_unit: mm
#supported_features: 3

#image:
#  - file: mdi_weather_cloudy: "\U000F0590"
#    id: alert
#    resize: 120x120

# https://tutoduino.fr/en/home-assistant-weather-reterminal-e1001/

display:
  - platform: rpi_dpi_rgb
    id: main_display
    color_order: RGB
    invert_colors: True
    auto_clear_enabled: false
    update_interval: 10s
    dimensions:
      width: 800
      height: 480
    de_pin: 41
    hsync_pin: 39
    vsync_pin: 40
    pclk_pin: 0
    pclk_frequency: 20MHz
    hsync_pulse_width: 48
    hsync_front_porch: 40
    hsync_back_porch: 40
    vsync_pulse_width: 31
    vsync_front_porch: 1
    vsync_back_porch: 13
    data_pins:
      red:
        - 14        #r1
        - 21        #r2
        - 47        #r3
        - 48        #r4
        - 45        #r5
      green:
        - 9         #g0
        - 46        #g1
        - 3         #g2
        - 8         #g3
        - 16        #g4
        - 1         #g5
      blue:
        - 15        #b1
        - 7         #b2
        - 6         #b3
        - 5         #b4
        - 4         #b5
    lambda: |-
      auto black = Color(0, 0, 0);
      auto red = Color(255, 0, 0);
      auto green = Color(0, 255, 0);
      auto blue = Color(0, 0, 255);
      auto white = Color(255, 255, 255);

      int base_x, base_y, section_gap, icon_gap;
           
      base_x = 50;
      base_y = 10;
      section_gap = 175;
      icon_gap = 40;
      char buffer[25];
      const char* icon;

      std::string condition = id(myWeather).state;

      if (condition == "sunny") {
          icon = "\U000F0599"; 
        } else if (condition == "partlycloudy") {
          icon = "\U000F0595"; 
        } else if (condition == "cloudy") {
          icon = "\U000F0590"; 
        } else if (condition == "rainy") {
          icon = "\U000F0597"; 
        } else if (condition == "snowy") {
          icon = "\U000F0598"; 
        } else if (condition == "pouring") {
          icon = "\U000F0596";      
        } else if (condition == "lightning") {
          icon = "\U000F0593";      
        } else if (condition == "clear-night") {
          icon = "\U000F0594";
        } else if (condition == "night-partlycloudy") {
          icon = "\U000F0F31"; 
        } else if (condition == "fog") {
          icon = "\U000F0591"; 
        } else if (condition == "hail") {
          icon = "\U000F0592"; 
        } else if (condition == "lightning-rainy") {
          icon = "\U000F067E";         
        } else if (condition == "snowy-rainy") {
          icon = "\U000F0F35"; 
        } else if (condition == "windy") {
          icon = "\U000F059D"; 
        } else if (condition == "windy-variant") {
          icon = "\U000F059E"; 
        } else if (condition == "exceptional") {
          icon = "\U000F0F2F";
        } else {
          icon = "\U000F0F2F"; // default 
        }

      // Convert first character to uppercase
      condition[0] = (char)toupper((unsigned char)condition[0]);
        
      it.filled_rectangle(10, 10, 250, 85, COLOR_OFF);
      it.printf(base_x + 55, base_y, id(myFont60), id(green), "%s", condition.c_str());
      it.printf(base_x - icon_gap, base_y - 10, id(icon_font_90), id(green), icon); // 

      base_x = 50;
      base_y = 175;

      it.filled_rectangle(675, 10, 125, 40, COLOR_OFF);
      snprintf(buffer, sizeof(buffer), "%s:%s",
               currenttime->now().strftime("%H").c_str(),
               currenttime->now().strftime("%M").c_str());
      it.printf(730, 10, id(myFont), id(yellow), "%s", buffer);
      it.printf(695, 11, id(icon_font_30), id(yellow), "\U000F1442"); // clock

      it.filled_rectangle(400, 10, 250, 60, COLOR_OFF);
      it.printf(430, 10, id(myFont60), id(red), "%s°C", id(myTemperature).state.c_str());
      it.printf(400, 28, id(icon_font_30), id(red), "\U000F050F"); // thermometer

      it.filled_rectangle(660, 90, 140, 80, COLOR_OFF);
      it.printf(690, 100, id(myFont40), id(blue), "%s%%", id(myHumidity).state.c_str()); 
      it.printf(660, 110, id(icon_font_30), id(blue), "\U000F058E"); // humidity

      int pressure = atoi(id(myPressure).state.c_str());
      it.filled_rectangle(400, 90, 250, 80, COLOR_OFF);
      it.printf(435, 100, id(myFont40), id(blue), "%d hpa", pressure); 
      it.printf(400, 110, id(icon_font_30), id(blue), "\U000F1442"); // Clock

      it.filled_rectangle(10, 350, 320, 80, COLOR_OFF);
      it.printf(85, 355, id(myFont60), id(blue), "%s%%", id(myBattery).state.c_str()); 
      
      if (atoi(id(myBattery).state.c_str()) <= 25) { it.printf(5, 345, id(icon_font_90), id(red), "\U000F12A1"); }  // Low Battery
      else if (atoi(id(myBattery).state.c_str()) <= 50) { it.printf(5, 345, id(icon_font_90), id(yellow), "\U000F12A2");  } // Medium Battery 
      else  { it.printf(5, 345, id(icon_font_90), id(green), "\U000F12A3"); } // High Battery 
           
      base_y = 210;
      std::vector<std::string> direction = {"N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"};   
      int dir = atoi(id(myWindBearing).state.c_str()) / 22.5;
      float windspeed = atoi((id(myWindspeed).state.c_str())) * 0.62137119;
      it.filled_rectangle(10, 90, 320, 85, COLOR_OFF);
      it.printf(50, 100, id(myFont40), id(sky_blue), "%s / %.0fmph", direction[dir].c_str(), windspeed); 
      it.printf(10, 110, id(icon_font_30), id(sky_blue), "\U000F059D"); // Windy

#//      it.filled_rectangle(base_x * 1, base_y + 1, 200, 39, COLOR_OFF);
#//      it.printf(base_x, base_y, id(myFont), id(red), "%s°C", id(myDewpoint).state.c_str());
#//      it.printf(base_x - icon_gap, base_y, id(icon_font_30), id(red), "\U000F050F"); // thermomete
